using BUS.CabinClass;
using BUS.Seat;
using DTO.Seat;
using GUI.Components.Buttons;
using GUI.Components.Inputs;
using System;
using System.Collections.Generic;
using System.Drawing;
using System.Linq;
using System.Text.RegularExpressions;
using System.Windows.Forms;
using GUI.Components.Buttons;
using GUI.Components.Inputs;
using BUS.Seat;
using BUS.CabinClass;
using DTO.Seat;
namespace GUI.Features.Seat.SubFeatures
{
    // DTO t·∫°m th·ªùi cho ComboBox (ch·ª©a c·∫£ t√™n v√† ID)
    public class ComboboxItem
    {
        public string Name { get; set; }
        public int Id { get; set; }
        public override string ToString() => Name;
    }

    public class SeatListControl : UserControl
    {
        private const bool USE_PLAIN_BUTTON_FOR_COLOR = true;

        // K√≠ch th∆∞·ªõc layout
        private const int RowLabelWidth = 56;
        private const int SeatWidth = 84;
        private const int SeatHeight = 52;
        private const int AisleWidth = 40;
        private const int SeatGap = 8;

        public readonly SeatBUS _seatBUS;
        private readonly CabinClassBUS _cabinClassBUS;
        public event Action<int> ViewOrEditRequested;
        public event Action<int> EditRequested;

        private TableLayoutPanel root, filterWrap, formPanel, contentLayout;
        private FlowLayoutPanel filterLeft, filterRight, legend;
        private Label lblTitle, lblFormTitle;

        private UnderlinedComboBox cbAircraft, cbClass, cbFormAircraft, cbFormClass;
        private UnderlinedTextField txtSeat, txtFormSeat;
        private PrimaryButton btnSearch, btnGenerate, btnSave;
        private SecondaryButton btnClear, btnReset, btnToggleForm;

        private Panel mapHost, formHost;
        private TableLayoutPanel centerLayout;
        private FlowLayoutPanel stack;
        private ToolTip tip;
        private System.Windows.Forms.Timer debounce;

        private List<SeatDTO> datasource = new();
        private List<ComboboxItem> _aircraftItems = new List<ComboboxItem>();
        private List<ComboboxItem> _classItems = new List<ComboboxItem>();
        private SeatDTO? _seatToEdit;
        private bool _isFormVisible = false;

        public SeatListControl()
        {
            _seatBUS = new SeatBUS();
            _cabinClassBUS = new CabinClassBUS();
            tip = new ToolTip();
            InitializeComponent();
            LoadData();
        }

        private void InitializeComponent()
        {
            SuspendLayout();
            Dock = DockStyle.Fill;
            BackColor = Color.FromArgb(232, 240, 252);

            lblTitle = new Label
            {
                Text = "ü™ë Danh s√°ch gh·∫ø",
                AutoSize = true,
                Font = new Font("Segoe UI", 20, FontStyle.Bold),
                Padding = new Padding(24, 20, 24, 0),
                Dock = DockStyle.Top
            };

            // Filters
            filterLeft = new FlowLayoutPanel { Dock = DockStyle.Fill, AutoSize = true, WrapContents = false };
            cbAircraft = new UnderlinedComboBox("M√°y bay", new object[] { }) { Width = 180, Margin = new Padding(0, 0, 24, 0) };
            cbClass = new UnderlinedComboBox("H·∫°ng", new object[] { }) { Width = 180, Margin = new Padding(0, 0, 24, 0) };
            txtSeat = new UnderlinedTextField("S·ªë gh·∫ø (VD: 12A)", "") { Width = 160, Margin = new Padding(0, 0, 24, 0) };
            
            filterLeft.Controls.AddRange(new Control[] { cbAircraft, cbClass, txtSeat });

            filterRight = new FlowLayoutPanel { Dock = DockStyle.Fill, AutoSize = true, FlowDirection = FlowDirection.RightToLeft, WrapContents = false };
            btnSearch = new PrimaryButton("üîç T√¨m ki·∫øm") { Width = 110, Height = 36 };
            btnClear = new SecondaryButton("‚ü≤ X√≥a l·ªçc") { Width = 100, Height = 36, Margin = new Padding(12, 0, 0, 0) };
            btnToggleForm = new SecondaryButton("‚ûï Th√™m gh·∫ø") { Width = 130, Height = 36, Margin = new Padding(12, 0, 0, 0) };
            btnGenerate = new PrimaryButton("‚öôÔ∏è Sinh gh·∫ø t·ª± ƒë·ªông") { Width = 170, Height = 36, Margin = new Padding(12, 0, 0, 0) };
            filterRight.Controls.Add(btnSearch);
            filterRight.Controls.Add(btnClear);
            //filterRight.Controls.Add(btnToggleForm);
            //filterRight.Controls.Add(btnGenerate);

            filterWrap = new TableLayoutPanel { Dock = DockStyle.Top, AutoSize = true, Padding = new Padding(24, 16, 24, 0), ColumnCount = 2 };
            filterWrap.ColumnStyles.Add(new ColumnStyle(SizeType.Percent, 100f));
            filterWrap.ColumnStyles.Add(new ColumnStyle(SizeType.AutoSize));
            filterWrap.Controls.Add(filterLeft, 0, 0);
            filterWrap.Controls.Add(filterRight, 1, 0);

            // Form th√™m/s·ª≠a gh·∫ø
            InitializeFormPanel();

            // Legend
            legend = new FlowLayoutPanel
            {
                Dock = DockStyle.Top,
                AutoSize = true,
                Padding = new Padding(24, 6, 24, 0),
                WrapContents = false
            };
            legend.Controls.Add(Badge("Gh·∫ø hi·ªán c√≥", Color.FromArgb(232, 245, 233), Color.FromArgb(27, 94, 32)));
            legend.Controls.Add(Badge("V·ªã tr√≠ tr·ªëng", Color.FromArgb(250, 250, 250), Color.FromArgb(158, 158, 158)));
            legend.Controls.Add(Badge("Kh√¥ng thu·ªôc b·ªô l·ªçc", Color.FromArgb(245, 245, 245), Color.FromArgb(158, 158, 158)));

            // Map host
            mapHost = new Panel
            {
                Dock = DockStyle.Fill,
                Padding = new Padding(32, 16, 32, 72),
                AutoScroll = true,
                BackColor = Color.White
            };

            centerLayout = new TableLayoutPanel
            {
                Dock = DockStyle.Top,
                AutoSize = true,
                ColumnCount = 3
            };
            centerLayout.ColumnStyles.Add(new ColumnStyle(SizeType.Percent, 50f));
            centerLayout.ColumnStyles.Add(new ColumnStyle(SizeType.AutoSize));
            centerLayout.ColumnStyles.Add(new ColumnStyle(SizeType.Percent, 50f));

            stack = new FlowLayoutPanel
            {
                FlowDirection = FlowDirection.TopDown,
                AutoSize = true,
                WrapContents = false
            };
            centerLayout.Controls.Add(stack, 1, 0);
            mapHost.Controls.Add(centerLayout);

            // Content layout - ch·ª©a form v√† map
            contentLayout = new TableLayoutPanel
            {
                Dock = DockStyle.Fill,
                ColumnCount = 2,
                RowCount = 1
            };
            contentLayout.ColumnStyles.Add(new ColumnStyle(SizeType.Absolute, 0)); // Form column - ban ƒë·∫ßu ·∫©n
            contentLayout.ColumnStyles.Add(new ColumnStyle(SizeType.Percent, 100f)); // Map column
            contentLayout.Controls.Add(formHost, 0, 0);
            contentLayout.Controls.Add(mapHost, 1, 0);

            // Events
            btnSearch.Click += (_, __) => ApplyFilter();
            btnClear.Click += (_, __) => { cbAircraft.SelectedIndex = 0; cbClass.SelectedIndex = 0; txtSeat.Text = ""; ApplyFilter(); };
            btnToggleForm.Click += (_, __) => ToggleForm();

            txtSeat.TextChanged += (_, __) => { debounce?.Stop(); debounce?.Start(); };
            cbAircraft.SelectedIndexChanged += (_, __) => ApplyFilter();
            cbClass.SelectedIndexChanged += (_, __) => ApplyFilter();

            debounce = new System.Windows.Forms.Timer { Interval = 280 };
            debounce.Tick += (_, __) => { debounce.Stop(); ApplyFilter(); };

            // Root
            root = new TableLayoutPanel { Dock = DockStyle.Fill, ColumnCount = 1, RowCount = 4, BackColor = Color.Transparent };
            root.RowStyles.Add(new RowStyle(SizeType.AutoSize)); // Title
            root.RowStyles.Add(new RowStyle(SizeType.AutoSize)); // Filter
            root.RowStyles.Add(new RowStyle(SizeType.AutoSize)); // Legend
            root.RowStyles.Add(new RowStyle(SizeType.Percent, 100f)); // Content (Form + Map)
            root.Controls.Add(lblTitle, 0, 0);
            root.Controls.Add(filterWrap, 0, 1);
            root.Controls.Add(legend, 0, 2);
            root.Controls.Add(contentLayout, 0, 3);

            Controls.Clear();
            Controls.Add(root);
            ResumeLayout(false);
        }

        private void InitializeFormPanel()
        {
            formHost = new Panel
            {
                Dock = DockStyle.Fill,
                AutoScroll = true,
                Visible = true,
                Padding = new Padding(12, 16, 12, 16),
                BackColor = Color.FromArgb(248, 249, 250)
            };

            var formCard = new GroupBox
            {
                Text = "  ‚ûï Th√™m gh·∫ø m·ªõi  ",
                Font = new Font("Segoe UI", 12f, FontStyle.Bold),
                AutoSize = true,
                AutoSizeMode = AutoSizeMode.GrowAndShrink,
                Padding = new Padding(16),
                ForeColor = Color.FromArgb(33, 37, 41),
                Dock = DockStyle.Top
            };

            formPanel = new TableLayoutPanel
            {
                AutoSize = true,
                ColumnCount = 1,
                Padding = new Padding(8),
                RowCount = 3
            };

            // T·∫°o ComboBox v·ªõi style
            cbFormAircraft = new UnderlinedComboBox("M√°y bay", Array.Empty<object>())
            {
                Width = 320,
                Margin = new Padding(0, 8, 0, 8),
                Dock = DockStyle.None
            };

            cbFormClass = new UnderlinedComboBox("H·∫°ng gh·∫ø", Array.Empty<object>())
            {
                Width = 320,
                Margin = new Padding(0, 8, 0, 8),
                Dock = DockStyle.None
            };

            txtFormSeat = new UnderlinedTextField("S·ªë gh·∫ø (VD: 12A)", "")
            {
                Width = 320,
                Margin = new Padding(0, 8, 0, 8),
                Dock = DockStyle.None
            };

            // Th√™m v√†o form panel
            formPanel.Controls.Add(cbFormAircraft, 0, 0);
            formPanel.Controls.Add(cbFormClass, 0, 1);
            formPanel.Controls.Add(txtFormSeat, 0, 2);

            var actions = new FlowLayoutPanel
            {
                AutoSize = true,
                Padding = new Padding(8, 12, 8, 8),
                WrapContents = false,
                FlowDirection = FlowDirection.TopDown
            };
            btnSave = new PrimaryButton("üíæ L∆∞u") { Width = 320, Height = 36, Margin = new Padding(0, 0, 0, 8) };
            btnReset = new SecondaryButton("‚úñ H·ªßy") { Width = 320, Height = 36 };

            btnSave.Click += Save_Click;
            btnReset.Click += Reset_Click;
            actions.Controls.AddRange(new Control[] { btnSave, btnReset });

            var formStack = new FlowLayoutPanel
            {
                FlowDirection = FlowDirection.TopDown,
                AutoSize = true,
                WrapContents = false,
                Dock = DockStyle.Top
            };
            formStack.Controls.Add(formPanel);
            formStack.Controls.Add(actions);

            formCard.Controls.Add(formStack);
            formHost.Controls.Add(formCard);

            // Thi·∫øt l·∫≠p DisplayMember / ValueMember cho ComboBox b√™n trong UnderlinedComboBox
            if (cbFormAircraft.InnerCombo is ComboBox rawCbAircraft)
            {
                rawCbAircraft.DisplayMember = "Name";
                rawCbAircraft.ValueMember = "Id";
                rawCbAircraft.DropDownStyle = ComboBoxStyle.DropDownList;
            }
            if (cbFormClass.InnerCombo is ComboBox rawCbClass)
            {
                rawCbClass.DisplayMember = "Name";
                rawCbClass.ValueMember = "Id";
                rawCbClass.DropDownStyle = ComboBoxStyle.DropDownList;
            }
        }

        private void ToggleForm()
        {
            _isFormVisible = !_isFormVisible;
            btnToggleForm.Text = _isFormVisible ? "‚ñ≤ ·∫®n form" : "‚ûï Th√™m gh·∫ø";

            if (_isFormVisible)
            {
                // Hi·ªÉn th·ªã form b√™n c·∫°nh map
                contentLayout.ColumnStyles[0] = new ColumnStyle(SizeType.Absolute, 380);
                contentLayout.ColumnStyles[1] = new ColumnStyle(SizeType.Percent, 100f);
                SetCreateMode();
            }
            else
            {
                // ·∫®n form, map chi·∫øm to√†n b·ªô
                contentLayout.ColumnStyles[0] = new ColumnStyle(SizeType.Absolute, 0);
                contentLayout.ColumnStyles[1] = new ColumnStyle(SizeType.Percent, 100f);
            }
        }

        private Control Badge(string text, Color bg, Color fg)
        {
            var p = new Panel { BackColor = bg, Height = 24, Padding = new Padding(10, 3, 10, 3), Margin = new Padding(0, 0, 8, 0), AutoSize = true };
            p.Controls.Add(new Label { Text = text, AutoSize = true, ForeColor = fg, Font = new Font("Segoe UI", 9f, FontStyle.Bold) });
            return p;
        }

        public async void LoadData()
        {
            try
            {
                System.Diagnostics.Debug.WriteLine("=== [SeatListControl] LoadData() START ===");
                var seatsWithDetails = _seatBUS.GetAllSeatsWithDetails();
                datasource = seatsWithDetails;
                System.Diagnostics.Debug.WriteLine($"[SeatListControl] Loaded {seatsWithDetails.Count} seats from database");
                
                // Debug: Log unique aircraft in seats
                var uniqueAircrafts = seatsWithDetails
                    .Select(s => $"{s.AircraftManufacturer} {s.AircraftModel}")
                    .Distinct()
                    .ToList();
                System.Diagnostics.Debug.WriteLine($"[SeatListControl] Seats contain {uniqueAircrafts.Count} unique aircraft:");
                foreach (var ac in uniqueAircrafts)
                {
                    System.Diagnostics.Debug.WriteLine($"  - {ac}");
                }
                
                UpdateFilterComboBoxes(seatsWithDetails);
                LoadFormComboboxData(seatsWithDetails);
                ApplyFilter();
                System.Diagnostics.Debug.WriteLine("=== [SeatListControl] LoadData() COMPLETE ===\n");
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"[SeatListControl] ERROR in LoadData: {ex.Message}");
                MessageBox.Show("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu gh·∫ø: " + ex.Message, "L·ªói Database", MessageBoxButtons.OK, MessageBoxIcon.Error);
                datasource = new List<SeatDTO>();
                ApplyFilter();
            }
        }

        private void LoadFormComboboxData(List<SeatDTO> allSeats)
        {
            try
            {
                // Load Aircraft t·ª´ seats
                _aircraftItems = allSeats
                    .Select(s => new { s.AircraftId, Name = $"{s.AircraftManufacturer} {s.AircraftModel}" })
                    .Distinct()
                    .Select(a => new ComboboxItem { Id = a.AircraftId, Name = a.Name })
                    .OrderBy(a => a.Name)
                    .ToList();

                // Load Classes t·ª´ database thay v√¨ t·ª´ seats
                var allCabinClasses = _cabinClassBUS.GetAllCabinClasses();
                _classItems = allCabinClasses
                    .Select(c => new ComboboxItem { Id = c.ClassId, Name = c.ClassName })
                    .OrderBy(c =>
                    {
                        // S·∫Øp x·∫øp theo th·ª© t·ª± ∆∞u ti√™n
                        var order = new Dictionary<string, int>
                        {
                            { "First", 1 },
                            { "Business", 2 },
                            { "Premium Economy", 3 },
                            { "Economy", 4 }
                        };
                        return order.ContainsKey(c.Name) ? order[c.Name] : 99;
                    })
                    .ThenBy(c => c.Name)
                    .ToList();

                if (cbFormAircraft.InnerCombo is ComboBox rawCbAircraft)
                    rawCbAircraft.DataSource = _aircraftItems;

                if (cbFormClass.InnerCombo is ComboBox rawCbClass)
                    rawCbClass.DataSource = _classItems;
            }
            catch (Exception ex)
            {
                MessageBox.Show("Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu form: " + ex.Message, "L·ªói", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void SetCreateMode()
        {
            _seatToEdit = null;
            if (formHost.Controls[0] is GroupBox formCard)
            {
                formCard.Text = "  ‚ûï Th√™m gh·∫ø m·ªõi  ";
            }
            txtFormSeat.Text = "";

            if (cbFormAircraft.InnerCombo is ComboBox rawCbAircraft)
            {
                if (rawCbAircraft.DataSource != null)
                    rawCbAircraft.SelectedIndex = -1;
                else
                    rawCbAircraft.SelectedItem = null;
            }

            if (cbFormClass.InnerCombo is ComboBox rawCbClass)
            {
                if (rawCbClass.DataSource != null)
                    rawCbClass.SelectedIndex = -1;
                else
                    rawCbClass.SelectedItem = null;
            }

            btnReset.Text = "‚úñ H·ªßy";
        }

        public void LoadSeatForEdit(int seatId)
        {
            if (_aircraftItems == null || _aircraftItems.Count == 0 ||
                _classItems == null || _classItems.Count == 0)
            {
                LoadData();
            }

            var freshSeatData = datasource.FirstOrDefault(s => s.SeatId == seatId);

            if (freshSeatData == null)
            {
                MessageBox.Show("Kh√¥ng t√¨m th·∫•y gh·∫ø ƒë·ªÉ s·ª≠a");
                return;
            }

            // Hi·ªÉn th·ªã form n·∫øu ƒëang ·∫©n
            if (!_isFormVisible)
            {
                ToggleForm();
            }

            _seatToEdit = freshSeatData;
            if (formHost.Controls[0] is GroupBox formCard)
            {
                formCard.Text = $"  ‚úèÔ∏è S·ª≠a gh·∫ø #{freshSeatData.SeatId}  ";
            }
            txtFormSeat.Text = freshSeatData.SeatNumber;

            if (cbFormAircraft.InnerCombo is ComboBox rawCbAircraft)
                rawCbAircraft.SelectedIndex = _aircraftItems.FindIndex(a => a.Id == freshSeatData.AircraftId);

            if (cbFormClass.InnerCombo is ComboBox rawCbClass)
                rawCbClass.SelectedIndex = _classItems.FindIndex(c => c.Id == freshSeatData.ClassId);

            btnReset.Text = "‚úñ H·ªßy";
        }

        private void Reset_Click(object? sender, EventArgs e)
        {
            SetCreateMode();
            if (_isFormVisible)
            {
                ToggleForm();
            }
        }

        private void Save_Click(object? sender, EventArgs e)
        {
            var rawCbAircraft = cbFormAircraft.InnerCombo as ComboBox;
            var rawCbClass = cbFormClass.InnerCombo as ComboBox;

            bool isEditing = _seatToEdit != null;
            var seatNumber = (txtFormSeat.Text ?? "").Trim().ToUpper();

            int? aircraftId = rawCbAircraft?.SelectedValue as int? ??
                              (rawCbAircraft?.SelectedItem as ComboboxItem)?.Id;
            int? classId = rawCbClass?.SelectedValue as int? ??
                           (rawCbClass?.SelectedItem as ComboboxItem)?.Id;

            if (aircraftId == null || aircraftId <= 0)
            {
                MessageBox.Show("Vui l√≤ng ch·ªçn M√°y bay h·ª£p l·ªá.", "Thi·∫øu th√¥ng tin", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }
            if (classId == null || classId <= 0)
            {
                MessageBox.Show("Vui l√≤ng ch·ªçn H·∫°ng gh·∫ø h·ª£p l·ªá.", "Thi·∫øu th√¥ng tin", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            if (!Regex.IsMatch(seatNumber, @"^[1-9]\d*[A-F]$"))
            {
                MessageBox.Show("S·ªë gh·∫ø kh√¥ng h·ª£p l·ªá. V√≠ d·ª•: 12A.", "L·ªói ƒë·ªãnh d·∫°ng", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            var seatToProcess = new SeatDTO(
                seatId: isEditing ? _seatToEdit!.SeatId : 0,
                aircraftId: aircraftId.Value,
                seatNumber: seatNumber,
                classId: classId.Value
            );

            try
            {
                bool success;
                string message;
                string action = isEditing ? "C·∫≠p nh·∫≠t" : "Th√™m m·ªõi";

                if (isEditing)
                    success = _seatBUS.UpdateSeat(seatToProcess, out message);
                else
                    success = _seatBUS.AddSeat(seatToProcess, out message);

                if (success)
                {
                    MessageBox.Show($"{action} gh·∫ø th√†nh c√¥ng!", "Th√†nh c√¥ng", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    SetCreateMode();
                    LoadData();
                }
                else
                {
                    MessageBox.Show($"Kh√¥ng th·ªÉ {action} gh·∫ø. Chi ti·∫øt: " + message, "Th·∫•t b·∫°i", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("L·ªói h·ªá th·ªëng khi l∆∞u gh·∫ø: " + ex.Message, "L·ªói", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void UpdateFilterComboBoxes(List<SeatDTO> data)
        {
            // T·∫°m remove event ƒë·ªÉ kh√¥ng trigger filter khi ƒëang populate
            cbAircraft.SelectedIndexChanged -= (_, __) => ApplyFilter();
            cbClass.SelectedIndexChanged -= (_, __) => ApplyFilter();

            // ========== LOAD AIRCRAFT ==========
            cbAircraft.Items.Clear();
            cbAircraft.Items.Add("T·∫•t c·∫£");
            
            try
            {
                // L·∫•y T·∫§T C·∫¢ aircraft t·ª´ AircraftBUS (kh√¥ng filter g√¨ c·∫£)
                var aircraftBus = new BUS.Aircraft.AircraftBUS();
                var allAircrafts = aircraftBus.GetAllAircrafts();
                
                System.Diagnostics.Debug.WriteLine($"[UpdateFilter] Total aircraft from DB: {allAircrafts.Count}");
                
                // Th√™m t·∫•t c·∫£ v√†o ComboBox (s·∫Øp x·∫øp theo t√™n)
                foreach (var aircraft in allAircrafts.OrderBy(a => a.Manufacturer).ThenBy(a => a.Model))
                {
                    string name = $"{aircraft.Manufacturer} {aircraft.Model}";
                    cbAircraft.Items.Add(name);
                    System.Diagnostics.Debug.WriteLine($"[UpdateFilter] Added: {name}");
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"[UpdateFilter] ERROR: {ex.Message}");
            }
            
            cbAircraft.SelectedIndex = 0;

            // ========== LOAD CABIN CLASSES ==========
            cbClass.Items.Clear();
            cbClass.Items.Add("T·∫•t c·∫£");
            
            try
            {
                // L·∫•y T·∫§T C·∫¢ cabin classes
                var classes = _cabinClassBUS.GetAllCabinClasses();
                
                foreach (var c in classes.OrderBy(x => x.ClassName))
                {
                    cbClass.Items.Add(c.ClassName);
                }
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"[UpdateFilter] ERROR loading classes: {ex.Message}");
            }
            
            cbClass.SelectedIndex = 0;

            // Add event l·∫°i
            cbAircraft.SelectedIndexChanged += (_, __) => ApplyFilter();
            cbClass.SelectedIndexChanged += (_, __) => ApplyFilter();
            
            System.Diagnostics.Debug.WriteLine($"[UpdateFilter] ComboBox populated: {cbAircraft.Items.Count} aircraft, {cbClass.Items.Count} classes");
        }

        // --- NEW: Clear and dispose controls properly to avoid handle leak ---
        private void ClearStackControls()
        {
            if (stack == null) return;
            stack.SuspendLayout();

            // Copy to list to avoid collection modification while iterating
            var old = stack.Controls.OfType<Control>().ToList();
            foreach (var c in old)
            {
                // remove then dispose (dispose will cascade to children)
                stack.Controls.Remove(c);
                try
                {
                    c.Dispose();
                }
                catch { /* ignore dispose errors */ }
            }

            stack.ResumeLayout();
        }

        private void ApplyFilter()
        {
            // dispose previous controls to free handles
            ClearStackControls();

            string ac = cbAircraft.SelectedItem?.ToString() ?? "T·∫•t c·∫£";
            string cl = cbClass.SelectedItem?.ToString() ?? "T·∫•t c·∫£";
            string key = (txtSeat.Text ?? "").Trim().ToUpperInvariant();

            var q = datasource.AsEnumerable();

            if (ac != "T·∫•t c·∫£") q = q.Where(x => $"{x.AircraftManufacturer} {x.AircraftModel}" == ac);
            if (cl != "T·∫•t c·∫£") q = q.Where(x => x.ClassName == cl);
            if (!string.IsNullOrEmpty(key)) q = q.Where(x => x.SeatNumber.Contains(key));

            var filteredSeats = q.ToList();

            if (filteredSeats.Count == 0)
            {
                stack.Controls.Add(new Label
                {
                    Text = "Kh√¥ng t√¨m th·∫•y gh·∫ø n√†o ph√π h·ª£p v·ªõi ƒëi·ªÅu ki·ªán l·ªçc.",
                    Font = new Font("Segoe UI", 12, FontStyle.Italic),
                    AutoSize = true,
                    Padding = new Padding(8)
                });
                return;
            }

            BuildSeatMap(filteredSeats);
        }

        private void BuildSeatMap(List<SeatDTO> filteredSeats)
        {
            // ensure previous controls removed
            ClearStackControls();

            string ac = cbAircraft.SelectedItem?.ToString() ?? "T·∫•t c·∫£";
            var baseFilter = datasource.AsEnumerable();
            if (ac != "T·∫•t c·∫£") baseFilter = baseFilter.Where(x => $"{x.AircraftManufacturer} {x.AircraftModel}" == ac);
            var allSeatsInSelection = baseFilter.ToList();

            var highlightDict = new Dictionary<string, SeatDTO>();
            foreach (var seat in filteredSeats)
            {
                highlightDict[seat.SeatNumber] = seat;
            }

            var groupedByAircraft = (ac == "T·∫•t c·∫£"
                ? filteredSeats
                : allSeatsInSelection)
                .GroupBy(s => new
                {
                    AircraftName = $"{s.AircraftManufacturer} {s.AircraftModel}",
                    s.AircraftId
                })
                .OrderBy(g => g.Key.AircraftName);

            // We'll add panels in batch; use SuspendLayout/ResumeLayout to minimize layout passes
            stack.SuspendLayout();

            foreach (var aircraftGroup in groupedByAircraft)
            {
                var firstSeat = aircraftGroup.FirstOrDefault();
                if (firstSeat == null) continue;

                var seatsInAircraft = allSeatsInSelection
                    .Where(s => s.AircraftId == firstSeat.AircraftId)
                    .ToList();

                if (seatsInAircraft.Count == 0) continue;

                char[] standardColumns = { 'A', 'B', 'C', 'D', 'E', 'F' };
                var sortedCols = standardColumns.ToList();

                int maxRowFromSeats = seatsInAircraft
                    .Select(s =>
                    {
                        string numStr = new string(s.SeatNumber.TakeWhile(char.IsDigit).ToArray());
                        return int.TryParse(numStr, out int n) ? n : 0;
                    })
                    .DefaultIfEmpty(0)
                    .Max();

                if (maxRowFromSeats == 0) continue;

                var sortedRows = Enumerable.Range(1, maxRowFromSeats).ToList();

                // === TH√äM T√äN M√ÅY BAY ·ªû TR√äN ===
                var aircraftLabel = new Label
                {
                    Text = $"‚úàÔ∏è {aircraftGroup.Key.AircraftName}",
                    Font = new Font("Segoe UI", 14f, FontStyle.Bold),
                    ForeColor = Color.FromArgb(33, 37, 41),
                    AutoSize = true,
                    Margin = new Padding(0, 16, 0, 12),
                    Padding = new Padding(8)
                };
                stack.Controls.Add(aircraftLabel);

                var headerPanel = new FlowLayoutPanel
                {
                    AutoSize = true,
                    WrapContents = false,
                    Margin = new Padding(0, 0, 0, 12)
                };

                headerPanel.Controls.Add(new Label { Width = RowLabelWidth, Height = 30, Text = "" });

                int headerAisleIndex = 3;
                for (int i = 0; i < sortedCols.Count; i++)
                {
                    if (i == headerAisleIndex)
                    {
                        headerPanel.Controls.Add(new Panel { Width = AisleWidth, Height = 1 });
                    }

                    var colLabel = new Label
                    {
                        Text = sortedCols[i].ToString(),
                        Width = SeatWidth - SeatGap,
                        Height = 30,
                        Font = new Font("Segoe UI", 11f, FontStyle.Bold),
                        TextAlign = ContentAlignment.MiddleCenter,
                        Margin = new Padding(SeatGap / 2),
                        ForeColor = Color.FromArgb(66, 66, 66)
                    };
                    headerPanel.Controls.Add(colLabel);
                }

                var grid = new TableLayoutPanel
                {
                    ColumnCount = sortedCols.Count + 2,
                    AutoSize = true,
                    AutoSizeMode = AutoSizeMode.GrowAndShrink
                };

                grid.ColumnStyles.Add(new ColumnStyle(SizeType.Absolute, RowLabelWidth));

                int gridAisleIndex = 3;
                for (int i = 0; i < sortedCols.Count; i++)
                {
                    if (i == gridAisleIndex)
                        grid.ColumnStyles.Add(new ColumnStyle(SizeType.Absolute, AisleWidth));
                    grid.ColumnStyles.Add(new ColumnStyle(SizeType.Absolute, SeatWidth));
                }

                var seatDict = seatsInAircraft.ToDictionary(s => s.SeatNumber, s => s);

                int rowIdx = 0;
                for (int idx = 0; idx < sortedRows.Count; idx++)
                {
                    int rowNo = sortedRows[idx];
                    grid.RowStyles.Add(new RowStyle(SizeType.Absolute, SeatHeight + SeatGap));

                    var lb = new Label
                    {
                        Text = rowNo.ToString(),
                        Width = RowLabelWidth,
                        Height = SeatHeight,
                        Font = new Font("Segoe UI", 12f, FontStyle.Bold),
                        TextAlign = ContentAlignment.MiddleCenter,
                        Margin = new Padding(0, SeatGap / 2, SeatGap, 0),
                        ForeColor = Color.FromArgb(66, 66, 66)
                    };
                    grid.Controls.Add(lb, 0, rowIdx);

                    int gridCol = 1;
                    for (int colIndex = 0; colIndex < sortedCols.Count; colIndex++)
                    {
                        char col = sortedCols[colIndex];
                        string seatNumber = $"{rowNo}{col}";

                        if (colIndex == gridAisleIndex)
                        {
                            grid.Controls.Add(new Panel { Width = AisleWidth, Height = 1, BackColor = Color.Transparent }, gridCol, rowIdx);
                            gridCol++;
                        }

                        if (highlightDict.TryGetValue(seatNumber, out SeatDTO seat))
                        {
                            grid.Controls.Add(MakeSeatButton(seat), gridCol, rowIdx);
                        }
                        else if (seatDict.TryGetValue(seatNumber, out SeatDTO dimSeat))
                        {
                            grid.Controls.Add(MakeDimmedSeat(dimSeat), gridCol, rowIdx);
                        }
                        else
                        {
                            grid.Controls.Add(MakeEmptySeat(seatNumber), gridCol, rowIdx);
                        }
                        gridCol++;
                    }

                    rowIdx++;
                }

                var aircraftStackPanel = new FlowLayoutPanel
                {
                    FlowDirection = FlowDirection.TopDown,
                    AutoSize = true,
                    WrapContents = false,
                    Margin = new Padding(0, 0, 0, 32)
                };
                aircraftStackPanel.Controls.Add(headerPanel);
                aircraftStackPanel.Controls.Add(grid);

                stack.Controls.Add(aircraftStackPanel);
            }

            stack.ResumeLayout();
        }

        private Button MakeSeatButton(SeatDTO seat)
        {
            Button btn = USE_PLAIN_BUTTON_FOR_COLOR ? new Button() : new SecondaryButton();
            btn.Text = seat.SeatNumber;
            btn.AutoSize = false;
            btn.Size = new Size(SeatWidth - SeatGap, SeatHeight);
            btn.Margin = new Padding(SeatGap / 2);
            btn.Font = new Font("Segoe UI", 10f, FontStyle.Bold);
            btn.FlatStyle = FlatStyle.Flat;
            btn.UseVisualStyleBackColor = false;
            btn.Cursor = Cursors.Hand;
            btn.Tag = seat.SeatId;

            btn.BackColor = Color.FromArgb(232, 245, 233);
            btn.ForeColor = Color.FromArgb(27, 94, 32);
            btn.FlatAppearance.BorderSize = 2;
            btn.FlatAppearance.BorderColor = Color.FromArgb(76, 175, 80);
            btn.FlatAppearance.MouseOverBackColor = Color.FromArgb(200, 230, 201);
            btn.FlatAppearance.MouseDownBackColor = Color.FromArgb(165, 214, 167);

            tip.SetToolTip(btn, $"Gh·∫ø {seat.SeatNumber} ‚Ä¢ {seat.ClassName}\nClick chu·ªôt ph·∫£i: Menu\nClick tr√°i: Xem chi ti·∫øt");

            btn.Click += (s, e) =>
            {
                if (e is MouseEventArgs me && me.Button == MouseButtons.Left)
                {
                    ViewOrEditRequested?.Invoke(seat.SeatId);
                }
            };

            btn.MouseUp += (s, e) =>
            {
                if (e.Button == MouseButtons.Right)
                {
                    ShowSeatContextMenu(btn, seat);
                }
            };

            return btn;
        }

        private void ShowSeatContextMenu(Control control, SeatDTO seat)
        {
            var menu = new ContextMenuStrip();

            var viewItem = new ToolStripMenuItem("üëÅÔ∏è Xem chi ti·∫øt", null, (s, e) => ViewOrEditRequested?.Invoke(seat.SeatId));
            var editItem = new ToolStripMenuItem("‚úèÔ∏è S·ª≠a th√¥ng tin", null, (s, e) =>
            {
                EditRequested?.Invoke(seat.SeatId);
                LoadSeatForEdit(seat.SeatId);
            });
            var deleteItem = new ToolStripMenuItem("üóëÔ∏è X√≥a gh·∫ø", null, (s, e) =>
            {
                if (MessageBox.Show($"B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a gh·∫ø {seat.SeatNumber}?", "X√°c nh·∫≠n x√≥a",
                    MessageBoxButtons.YesNo, MessageBoxIcon.Warning) == DialogResult.Yes)
                {
                    if (_seatBUS.DeleteSeat(seat.SeatId, out string message))
                    {
                        MessageBox.Show("ƒê√£ x√≥a gh·∫ø th√†nh c√¥ng.", "Th√†nh c√¥ng", MessageBoxButtons.OK, MessageBoxIcon.Information);
                        LoadData();
                    }
                    else
                    {
                        MessageBox.Show($"L·ªói khi x√≥a gh·∫ø: {message}", "L·ªói", MessageBoxButtons.OK, MessageBoxIcon.Error);
                    }
                }
            });

            deleteItem.ForeColor = Color.FromArgb(220, 53, 69);

            menu.Items.Add(viewItem);
            menu.Items.Add(editItem);
            menu.Items.Add(new ToolStripSeparator());
            menu.Items.Add(deleteItem);

            menu.Show(control, new Point(0, control.Height));
        }

        private Panel MakeEmptySeat(string position)
        {
            var panel = new Panel
            {
                Size = new Size(SeatWidth - SeatGap, SeatHeight),
                Margin = new Padding(SeatGap / 2),
                BackColor = Color.FromArgb(250, 250, 250),
                BorderStyle = BorderStyle.FixedSingle
            };

            var label = new Label
            {
                Text = "‚Äî",
                Dock = DockStyle.Fill,
                TextAlign = ContentAlignment.MiddleCenter,
                Font = new Font("Segoe UI", 14f),
                ForeColor = Color.FromArgb(189, 189, 189)
            };

            panel.Controls.Add(label);
            tip.SetToolTip(panel, $"V·ªã tr√≠ {position} - Ch∆∞a c√≥ gh·∫ø");

            return panel;
        }

        private Button MakeDimmedSeat(SeatDTO seat)
        {
            Button btn = USE_PLAIN_BUTTON_FOR_COLOR ? new Button() : new SecondaryButton();
            btn.Text = seat.SeatNumber;
            btn.AutoSize = false;
            btn.Size = new Size(SeatWidth - SeatGap, SeatHeight);
            btn.Margin = new Padding(SeatGap / 2);
            btn.Font = new Font("Segoe UI", 9f, FontStyle.Regular);
            btn.FlatStyle = FlatStyle.Flat;
            btn.FlatAppearance.BorderSize = 1;
            btn.UseVisualStyleBackColor = false;
            btn.Cursor = Cursors.Default;
            btn.Enabled = false;

            btn.BackColor = Color.FromArgb(245, 245, 245);
            btn.FlatAppearance.BorderColor = Color.FromArgb(220, 220, 220);
            btn.ForeColor = Color.FromArgb(158, 158, 158);

            tip.SetToolTip(btn, $"{seat.ClassName} ‚Ä¢ Gh·∫ø {seat.SeatNumber} (Kh√¥ng thu·ªôc b·ªô l·ªçc)");

            return btn;
        }
    }
}