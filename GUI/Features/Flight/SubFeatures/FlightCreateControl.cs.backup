<<<<<<< Updated upstream
Ôªøusing System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Data;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Windows.Forms;
using BUS.Flight; // Th√™m BUS
using DAO.Aircraft; // Th√™m DAO m·ªõi
using DAO.Route;   // Th√™m DAO m·ªõi
using DTO.Flight;  // Th√™m DTO

namespace GUI.Features.Flight.SubFeatures
{
    public partial class FlightCreateControl : UserControl
    {
        private int _currentRouteDurationMinutes = 0;
        private int? _editingFlightId = null;
        public event Action OnSaveSuccess;
        public FlightCreateControl()
        {
            InitializeComponent();
            LoadInitialData();

            dtpDepartureTime.DateTimePicker.ValueChanged += dtpDepartureTime_ValueChanged;
=======
using GUI.Components.Buttons;
using GUI.Components.Inputs;
using GUI.Components.Tables;
using BUS.Flight;
using BUS.Aircraft;
using BUS.Route;
using DTO.Flight;
using System.Linq;

namespace GUI.Features.Flight.SubFeatures {
    public class FlightCreateControl : UserControl {
        private readonly FlightBUS _flightBUS;
        private readonly AircraftBUS _aircraftBUS;
        private readonly RouteBUS _routeBUS;

        // Controls
        private UnderlinedTextField txtFlightNumber;
        private UnderlinedComboBox cboAircraft;
        private UnderlinedComboBox cboRoute;
        private DateTimePickerCustom dtpDeparture;
        private DateTimePickerCustom dtpArrival;
        private UnderlinedComboBox cboStatus;
        private PrimaryButton btnCreate;

        public event Action? DataChanged;

        public FlightCreateControl() {
            _flightBUS = new FlightBUS();
            _aircraftBUS = new AircraftBUS();
            _routeBUS = new RouteBUS();
            
            InitializeComponent();
            LoadComboBoxData();
>>>>>>> Stashed changes
        }

        private void FlightCreateControl_Load(object sender, EventArgs e)
        {
            dtpDepartureTime.DateTimePicker.Format = DateTimePickerFormat.Custom;
            dtpDepartureTime.DateTimePicker.CustomFormat = "dd/MM/yyyy HH:mm";

            dtpArrivalTime.DateTimePicker.Format = DateTimePickerFormat.Custom;
            dtpArrivalTime.DateTimePicker.CustomFormat = "dd/MM/yyyy HH:mm";
        }
        public void LoadFlightForEdit(int flightId)
        {
            _editingFlightId = flightId;
            lblTitle.Text = "‚úèÔ∏è Ch·ªânh s·ª≠a chuy·∫øn bay";
            btnSave.Text = "üíæ C·∫≠p nh·∫≠t chuy·∫øn bay";

            dtpDepartureTime.DateTimePicker.MinDate = new DateTime(2004, 1, 1);
            dtpArrivalTime.DateTimePicker.MinDate = new DateTime(2004, 1, 1);

<<<<<<< Updated upstream
            var result = FlightBUS.Instance.GetFlightById(flightId);
            if (!result.Success)
            {
                MessageBox.Show(result.GetFullErrorMessage(), "L·ªói", MessageBoxButtons.OK, MessageBoxIcon.Error);
                ClearForm();
                return;
=======
            // === C·ªôt 1 ===
            txtFlightNumber = new UnderlinedTextField("S·ªë hi·ªáu chuy·∫øn bay *", "") { 
                MinimumSize = new Size(0, 72), 
                Width = 300 
            };
            inputPanel.Controls.Add(txtFlightNumber, 0, 0);

            cboAircraft = new UnderlinedComboBox("M√°y bay *", new object[] { }) {
                MinimumSize = new Size(0, 72),
                Width = 300
            };
            inputPanel.Controls.Add(cboAircraft, 0, 1);

            dtpDeparture = new DateTimePickerCustom("Th·ªùi gian kh·ªüi h√†nh *", "") { 
                Width = 300, 
                Height = 72,
                EnableTime = true,
                TimeFormat = "dd/MM/yyyy HH:mm",
                ShowUpDownWhenTime = true
            };
            inputPanel.Controls.Add(dtpDeparture, 0, 2);

            cboStatus = new UnderlinedComboBox("Tr·∫°ng th√°i", new object[] { 
                "SCHEDULED", "DELAYED", "CANCELLED", "COMPLETED" 
            }) {
                MinimumSize = new Size(0, 72),
                Width = 300
            };
            cboStatus.SelectedIndex = 0; // M·∫∑c ƒë·ªãnh SCHEDULED
            inputPanel.Controls.Add(cboStatus, 0, 3);

            // === C·ªôt 2 ===
            cboRoute = new UnderlinedComboBox("Tuy·∫øn bay *", new object[] { }) { 
                MinimumSize = new Size(0, 72), 
                Width = 300 
            };
            inputPanel.Controls.Add(cboRoute, 1, 1);

            dtpArrival = new DateTimePickerCustom("Th·ªùi gian h·∫° c√°nh *", "") { 
                Width = 300, 
                Height = 72,
                EnableTime = true,
                TimeFormat = "dd/MM/yyyy HH:mm",
                ShowUpDownWhenTime = true
            };
            inputPanel.Controls.Add(dtpArrival, 1, 2);

            // Sau khi Add c√°c control v√†o inputPanel:
            for (int r = 0; r < inputPanel.RowCount; r++) {
                int h = 0;
                for (int c = 0; c < inputPanel.ColumnCount; c++) {
                    var ctl = inputPanel.GetControlFromPosition(c, r);
                    if (ctl != null) {
                        h = Math.Max(h, ctl.GetPreferredSize(Size.Empty).Height + ctl.Margin.Vertical);
                    }
                }
                inputPanel.RowStyles[r] = new RowStyle(SizeType.Absolute, Math.Max(72, h));
>>>>>>> Stashed changes
            }

            var flight = result.GetData<FlightDTO>();

<<<<<<< Updated upstream
            try
            {
                txtFlightNumber.Text = flight.FlightNumber;
=======
            // ===== N√∫t t·∫°o m·ªõi =====
            btnCreate = new PrimaryButton("‚ûï T·∫°o chuy·∫øn bay") {
                Height = 40,
                Width = 180,
                Margin = new Padding(0, 12, 0, 12),
                Anchor = AnchorStyles.Right
            };
            btnCreate.Click += BtnCreate_Click;

            var btnClear = new SecondaryButton("üîÑ L√†m m·ªõi") {
                Height = 40,
                Width = 120,
                Margin = new Padding(0, 12, 8, 12),
                Anchor = AnchorStyles.Right
            };
            btnClear.Click += (s, e) => ClearForm();

            var buttonRow = new FlowLayoutPanel {
                Dock = DockStyle.Top,
                FlowDirection = FlowDirection.RightToLeft,
                AutoSize = true,
                Padding = new Padding(24, 0, 24, 0),
                WrapContents = false
            };
            buttonRow.Controls.Add(btnCreate);
            buttonRow.Controls.Add(btnClear);
>>>>>>> Stashed changes

                cbAircraft.SelectedValue = flight.AircraftId;
                cbRoute.SelectedValue = flight.RouteId;
                cbStatus.SelectedValue = flight.Status;

                if (flight.DepartureTime.HasValue)
                    dtpDepartureTime.Value = flight.DepartureTime.Value;

                if (flight.ArrivalTime.HasValue)
                    dtpArrivalTime.Value = flight.ArrivalTime.Value;
            }
            catch (Exception ex)
            {
                MessageBox.Show("L·ªói khi ƒëi·ªÅn th√¥ng tin: " + ex.Message, "L·ªói", MessageBoxButtons.OK, MessageBoxIcon.Warning);
            }
        }

        private void LoadInitialData()
        {
            try
            {
                cbAircraft.DataSource = AircraftDAO.Instance.GetAllAircraftForComboBox();
                cbAircraft.DisplayMember = "DisplayName";
                cbAircraft.ValueMember = "aircraft_id";
                cbAircraft.SelectedIndex = -1;
                cbAircraft.SelectedIndexChanged += cbAircraft_SelectedIndexChanged;

                cbRoute.DataSource = RouteDAO.Instance.GetAllRoutesForComboBox();
                cbRoute.DisplayMember = "DisplayName";
                cbRoute.ValueMember = "route_id";
                cbRoute.SelectedIndex = -1;
                cbRoute.SelectedIndexChanged += cbRoute_SelectedIndexChanged;

                var statusValues = Enum.GetValues(typeof(FlightStatus))
                    .Cast<FlightStatus>()
                    .Select(s => new { Value = s, Description = s.GetDescription() })
                    .ToList();

                cbStatus.DataSource = statusValues;
                cbStatus.DisplayMember = "Description";
                cbStatus.ValueMember = "Value";
                cbStatus.SelectedValue = FlightStatus.SCHEDULED;

                DateTime minDate = DateTime.Now.AddHours(1);
                DateTime defaultDate = DateTime.Now.AddDays(1);

                dtpDepartureTime.DateTimePicker.MinDate = minDate;
                dtpDepartureTime.Value = (defaultDate > minDate) ? defaultDate : minDate;

                dtpArrivalTime.DateTimePicker.MinDate = dtpDepartureTime.Value;
                dtpArrivalTime.Value = dtpDepartureTime.Value.AddHours(2);

                txtFlightNumber.LabelText = "S·ªë hi·ªáu chuy·∫øn bay";
                txtFlightNumber.PlaceholderText = "Ch·ªçn m√°y bay ƒë·ªÉ g·ª£i √Ω...";
            }
            catch (Exception ex)
            {
                MessageBox.Show($"L·ªói khi t·∫£i danh s√°ch: {ex.Message}", "L·ªói", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }
        private void cbRoute_SelectedIndexChanged(object sender, EventArgs e)
        {
            _currentRouteDurationMinutes = 0;
            if (cbRoute.SelectedItem is DataRowView selectedRoute)
            {
                object durationObj = selectedRoute["duration_minutes"];
                if (durationObj != DBNull.Value && durationObj != null)
                {
                    _currentRouteDurationMinutes = Convert.ToInt32(durationObj);
                }
            }
            SuggestArrivalTime();
        }
        private void dtpDepartureTime_ValueChanged(object sender, EventArgs e)
        {
            dtpArrivalTime.DateTimePicker.MinDate = dtpDepartureTime.Value;

            SuggestArrivalTime();
        }
        private void SuggestArrivalTime()
        {
            if (_currentRouteDurationMinutes <= 0)
            {
                if (dtpArrivalTime.Value < dtpDepartureTime.Value)
                {
                    dtpArrivalTime.Value = dtpDepartureTime.Value.AddHours(1);
                }
                return;
            }

            try
            {
                DateTime departureTime = dtpDepartureTime.Value;

                DateTime suggestedArrivalTime = departureTime.AddMinutes(_currentRouteDurationMinutes);

                dtpArrivalTime.Value = suggestedArrivalTime;
            }
            catch (Exception)
            {
                dtpArrivalTime.Value = dtpDepartureTime.Value.AddHours(1);
            }
        }
        private void cbAircraft_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (cbAircraft.SelectedItem is DataRowView selectedAircraft)
            {
                try
                {
                    string airlineCode = selectedAircraft["airline_code"]?.ToString();

                    if (!string.IsNullOrEmpty(airlineCode))
                    {
                        LoadSuggestedFlightNumber(airlineCode);
                    }
                }
                catch (ArgumentException)
                {
                    txtFlightNumber.PlaceholderText = "L·ªói (kh√¥ng t√¨m th·∫•y code)";
                }
            }
            else
            {
                txtFlightNumber.PlaceholderText = "Ch·ªçn m√°y bay ƒë·ªÉ g·ª£i √Ω...";
            }
        }
        private void LoadSuggestedFlightNumber(string prefix)
        {
            var result = FlightBUS.Instance.SuggestNextFlightNumber(prefix);

            if (result.Success && result.Data != null)
            {
                txtFlightNumber.PlaceholderText = $"VD: {result.Data.ToString()}";
            }
            else
            {
                txtFlightNumber.PlaceholderText = $"VD: {prefix.ToUpper()}1";
            }
        }
        private void btnSave_Click(object sender, EventArgs e)
        {
            try
            {
                // 1. Thu th·∫≠p d·ªØ li·ªáu
                var flight = new FlightDTO
                {
                    FlightNumber = txtFlightNumber.Text,
                    AircraftId = Convert.ToInt32(cbAircraft.SelectedValue),
                    RouteId = Convert.ToInt32(cbRoute.SelectedValue),
                    DepartureTime = dtpDepartureTime.Value,
                    ArrivalTime = dtpArrivalTime.Value,
                    Status = (FlightStatus)cbStatus.SelectedValue
                };

                // 2. G·ªçi BUS
                BUS.Common.BusinessResult result;
                if (_editingFlightId.HasValue)
                {
                    flight.FlightId = _editingFlightId.Value;
                    result = FlightBUS.Instance.UpdateFlight(flight);
                }
                else
                {
                    result = FlightBUS.Instance.CreateFlight(flight);
                }

                // 3. Hi·ªÉn th·ªã k·∫øt qu·∫£
                if (result.Success)
                {
                    MessageBox.Show(result.Message, "Th√†nh c√¥ng", MessageBoxButtons.OK, MessageBoxIcon.Information);

                    ClearForm();

                    OnSaveSuccess?.Invoke();
                }
                else
                {
                    MessageBox.Show(result.GetFullErrorMessage(), "L·ªói", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
            catch (FormatException)
            {
                MessageBox.Show("Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß M√°y bay v√† Tuy·∫øn bay.", "Thi·∫øu th√¥ng tin", MessageBoxButtons.OK, MessageBoxIcon.Warning);
            }
            catch (Exception ex)
            {
                MessageBox.Show($"ƒê√£ x·∫£y ra l·ªói kh√¥ng mong mu·ªën: {ex.Message}", "L·ªói h·ªá th·ªëng", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }
        public void ClearForm()
        {
            _editingFlightId = null;
            lblTitle.Text = "‚ûï T·∫°o chuy·∫øn bay";
            btnSave.Text = "üíæ L∆∞u chuy·∫øn bay";

            txtFlightNumber.Text = "";
            cbAircraft.SelectedIndex = -1;
            cbRoute.SelectedIndex = -1;
            cbStatus.SelectedValue = FlightStatus.SCHEDULED;

            DateTime minDate = DateTime.Now.AddHours(1);
            DateTime defaultDate = DateTime.Now.AddDays(1);

            dtpDepartureTime.DateTimePicker.MinDate = minDate;
            dtpDepartureTime.Value = (defaultDate > minDate) ? defaultDate : minDate;

            dtpArrivalTime.DateTimePicker.MinDate = dtpDepartureTime.Value;
            dtpArrivalTime.Value = dtpDepartureTime.Value.AddHours(2);

            _currentRouteDurationMinutes = 0;
            txtFlightNumber.PlaceholderText = "Ch·ªçn m√°y bay ƒë·ªÉ g·ª£i √Ω...";
        }

        private void LoadComboBoxData()
        {
            try
            {
                // Load aircraft
                var aircrafts = _aircraftBUS.GetAllAircrafts();
                cboAircraft.Items.Clear();
                cboAircraft.Items.Add("-- Ch·ªçn m√°y bay --");
                foreach (var aircraft in aircrafts)
                {
                    cboAircraft.Items.Add(new ComboBoxItem { 
                        Value = aircraft.AircraftId, 
                        Text = $"{aircraft.Model} - {aircraft.Manufacturer} (ID: {aircraft.AircraftId})" 
                    });
                }
                cboAircraft.SelectedIndex = 0;

                // Load routes
                var routes = _routeBUS.GetAllRoutes();
                cboRoute.Items.Clear();
                cboRoute.Items.Add("-- Ch·ªçn tuy·∫øn bay --");
                foreach (var route in routes)
                {
                    cboRoute.Items.Add(new ComboBoxItem { 
                        Value = route.RouteId, 
                        Text = $"Route {route.RouteId} ({route.DistanceKm ?? 0} km)" 
                    });
                }
                cboRoute.SelectedIndex = 0;
            }
            catch (Exception ex)
            {
                MessageBox.Show("L·ªói khi t·∫£i d·ªØ li·ªáu: " + ex.Message, "L·ªói", 
                    MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void BtnCreate_Click(object sender, EventArgs e)
        {
            try
            {
                // Validate input
                if (string.IsNullOrWhiteSpace(txtFlightNumber.Text))
                {
                    MessageBox.Show("Vui l√≤ng nh·∫≠p s·ªë hi·ªáu chuy·∫øn bay", "Thi·∫øu th√¥ng tin", 
                        MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    txtFlightNumber.Focus();
                    return;
                }

                if (cboAircraft.SelectedIndex <= 0)
                {
                    MessageBox.Show("Vui l√≤ng ch·ªçn m√°y bay", "Thi·∫øu th√¥ng tin", 
                        MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }

                if (cboRoute.SelectedIndex <= 0)
                {
                    MessageBox.Show("Vui l√≤ng ch·ªçn tuy·∫øn bay", "Thi·∫øu th√¥ng tin", 
                        MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }

                // Validate th·ªùi gian
                DateTime departure = dtpDeparture.Value;
                DateTime arrival = dtpArrival.Value;

                if (arrival <= departure)
                {
                    MessageBox.Show("Th·ªùi gian h·∫° c√°nh ph·∫£i sau th·ªùi gian kh·ªüi h√†nh", "L·ªói th·ªùi gian", 
                        MessageBoxButtons.OK, MessageBoxIcon.Warning);
                    return;
                }

                // L·∫•y ID t·ª´ ComboBox
                int aircraftId = ((ComboBoxItem)cboAircraft.SelectedItem).Value;
                int routeId = ((ComboBoxItem)cboRoute.SelectedItem).Value;

                // Parse status
                FlightStatus status = FlightStatusExtensions.Parse(cboStatus.SelectedItem.ToString());

                // T·∫°o DTO
                var newFlight = new FlightDTO
                {
                    FlightNumber = txtFlightNumber.Text.Trim().ToUpper(),
                    AircraftId = aircraftId,
                    RouteId = routeId,
                    DepartureTime = departure,
                    ArrivalTime = arrival,
                    Status = status
                };

                // Th√™m v√†o database
                if (_flightBUS.AddFlight(newFlight, out string message))
                {
                    MessageBox.Show(message, "Th√†nh c√¥ng", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    ClearForm();
                    DataChanged?.Invoke(); // Notify parent to refresh
                }
                else
                {
                    MessageBox.Show(message, "L·ªói", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show("L·ªói khi t·∫°o chuy·∫øn bay: " + ex.Message, "L·ªói", 
                    MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void ClearForm()
        {
            txtFlightNumber.Text = "";
            cboAircraft.SelectedIndex = 0;
            cboRoute.SelectedIndex = 0;
            dtpDeparture.Value = DateTime.Now.AddHours(2);
            dtpArrival.Value = DateTime.Now.AddHours(4);
            cboStatus.SelectedIndex = 0;
            txtFlightNumber.Focus();
        }

        // Helper class for ComboBox items
        private class ComboBoxItem
        {
            public int Value { get; set; }
            public string Text { get; set; }
            public override string ToString() => Text;
        }
    }
}